-- 本脚本基于[SZ382031810](https://steamcommunity.com/sharedfiles/filedetails/?id=2908114886&searchtext=%E5%B1%A0%E9%BE%99)20230114版本MOD
game_data = {
    map_1 = {
        bag_guid = "5613a9",
        guid = "1e26d2",
        dst_pos = { 1.00, 1.03, 11.00 },
        dst_rot = { 0.00, 180.00, 0.00 },
        rage_pos = { 12.46, 2.12, 7.80 },
        mountain = {
            { -13.13, 2.5, 17.05 },
            { -4.44, 2.5, 14.05 },
            { 5.79, 2.5, 2.08 },
            { 7.60, 2.5, 11.06 },
            { 5.75, 2.5, 20.02 }
        },
        wonderworld = {
            { -7.82, 2.1, 14.01 },
            { -2.82, 2.1, 11.14 },
            { 0.77, 2.1, 5.09 },
            { 3.97, 2.1, 11.11 },
            { 0.74, 2.1, 17.00 }
        },
        city = { -8.00, 2.1, 4.00 },
        award = {
            bag_guid = "10c48c",
            guid = {
                { "龙的隐蔽所I", "9531c1" },
                { "龙的隐蔽所II", "4bd2d8" },
                { "龙之书", "1efc60" },
                { "屠龙武器", "6f928d" },
                { "龙之秘宝", "c650aa" },
            },
        },
        burned_village = {
            bag_guid = "e64500",
            guid = {
                { "贝尔村", "4d8c0e" }
            }
        },
        darksword = {
            { -9.60, 2.1, 17.89 },
            { -4.47, 2.1, 8.89 },
            { 4.10, 2.1, 5.98 },
            { 2.41, 2.1, 14.95 },
            { 4.12, 2.1, 17.94 }
        },
        limited = {
        }
    },
    map_2 = {
        bag_guid = "f02ca6",
        guid = "4a30f9",
        dst_pos = { 0.17, 1.45, 11.18 },
        dst_rot = { 0.00, 180.00, 0.00 },
        rage_pos = { -20.05, 2.12, 13.52 },
        rage_pos1 = { 19.57, 2.12, 8.80 },
        mountain = {
            { -9.27, 2.5, 20.07 },
            { -12.71, 2.5, 7.68 },
            { -4.11, 2.5, 10.85 },
            { 14.82, 2.5, 7.83 },
            { 14.78, 2.5, 20.16 },
        },
        wonderworld = {
            { -7.52, 1.99, 17.05 },
            { -9.29, 2.1, 7.77 },
            { 2.82, 2.1, 10.91 },
            { 11.36, 2.1, 7.78 },
            { 9.70, 2.1, 17.06 },
        },
        city = { 1.12, 2.1, 3.86 },
        award = {
            bag_guid = "64fc06",
            guid = {
                { "龙的隐蔽所I", "a389b3" },
                { "龙的隐蔽所II", "98f649" },
                { "龙之书", "e72a43" },
                { "屠龙武器", "6881b7" },
                { "龙之秘宝", "0cb3ec" },
            },
        },
        burned_village = {
            bag_guid = "f2cfd4",
            guid = {
                { "米斯特鲁村", "2122f0" },
                { "贝斯卡特村", "3318b9" },
            }
        },
        darksword = {
            { -10.96, 2.1, 11.88 },
            { -5.84, 2.1, 14.87 },
            { 1.10, 2.1, 8.81 },
            { 9.65, 2.1, 11.90 },
            { 8.00, 2.1, 14.93 }
        },
        limited = {
            mission = {
                bag_guid = "870b17",
                guid = { { "呼唤风暴的魔法机器", "544d5d" } },
            },
            obstacle = {
                bag_guid = "0d6ed8",
                guid = {
                    { "地形阻碍卡1", "a4ac25" },
                    { "地形阻碍卡2", "2ffd96" },
                },

            }
        }
    },
    map_3 = {
        bag_guid = "97be03",
        guid = "f80808",
        dst_pos = { 0.00, 1.03, 11.18 },
        dst_rot = { 0.00, 180.00, 0.00 },
        rage_pos = { -1.32, 2.12, 7.11 },
        mountain = {
            { -24.96, 2.5, 1.79 },
            { -18.16, 2.5, 7.74 },
            { 15.46, 2.5, 11.22 },
            { 25.56, 2.5, 17.16 },
            { 8.31, 2.5, 19.56 },
        },
        wonderworld = {
            { -18.15, 2.1, 13.73 },
            { -23.28, 2.1, 4.76 },
            { -16.54, 2.1, 4.78 },
            { 17.19, 2.1, 14.22 },
            { 23.93, 2.1, 14.11 },
        },
        city = { 1.43, 2.12, 2.52 },
        award = {
            bag_guid = "962122",
            guid = {
                { "龙缚的符咒", "10812c" },
                { "驱龙的魔香", "6ac6e7" },
                { "龙之书", "5415f3" },
                { "屠龙武器", "b8afa5" },
                { "龙之秘宝", "d2fb25" },
            },
        },
        burned_village = {
            bag_guid = "6526cd",
            guid = {
                { "布里萨", "6c3ccf" },
                { "弗尔睿", "a3df40" },
            }
        },
        darksword = {
            { -24.97, 2.1, 8.84 },
            { -21.64, 2.1, 2.76 },
            { -7.74, 2.1, 3.69 },
            { 15.41, 2.1, 18.08 },
            { 4.82, 2.1, 20.75 }
        },
        limited = {
            mission = {
                bag_guid = "af1788",
                guid = { { "隆隆作响的魔法装置", "728209" } },
            },
            wonderworld = {
                bag_guid = "067c73",
                guid = { { "技术高超的骑手", "27a308" } }
            },
            airroute = {
                bag_guid = "b2f754",
                guid = {
                    { "3以上", "6df80d" },
                    { "4以上", "5233c5" },
                    { "4以上2", "7b8d07" },
                    { "5以上", "36a789" },
                },
                dst_pos = {
                    { -11.70, 2.1, 19.74 },
                    { 8.33, 2.10, 12.60 },
                    { 11.22, 2.1, 5.66 },
                }
            },
            sky = {
                bag_guid = "61d68f",
                guid = {
                    { "魔龙标记", "73e6d6" },
                    { "风暴标记1", "d838f4" },
                    { "风暴标记2", "510506" },
                    { "目标标记", "143956" },
                }
            },
        }
    },
    mission = {
        bag_guid = "6530ff",
        guid = {
            -- 本体
            { { "魔像守护者", "c7497f" },
                { "史芬克斯的谜题", "abe7dc" },
                { "哥布林小队", "071361" },
                { "传送陷阱", "97532e" },
                { "魔兽奇美拉", "eaef08" },
                { "迷之碑文", "75b75d" },
                { "巨大的迷宫", "d90ada" }, },
            { { "大魔法师的试炼", "bc7c4a" },
                { "魔力之塔", "5371dc" },
                { "被封印的魔神", "0b284f" }, },
            { { "英雄的遗书", "9fa055" } },
            { { "不屈的铠武者", "448b47" },
                { "生命之泉", "7d37c9" },
                { "异国的邪教典", "8bfcd8" }, },
            { { "喧闹的幽灵", "73f954" },
                { "血染的魔法阵", "77ff65" },
                { "不死者的巢穴", "c35aff" }, },
            {},
            {},
            {},
            {},
            {},
            {},
            {},
            {},
            {},
        },
    },
    wonderworld = {
        bag_guid = "2c75ff",
        guid = {
            {},
            {},
            {},
            {},
            {
                { "流沙", "69c93b" },
                { "药草原野", "49f5e7" },
                { "瘴毒沼泽", "7368e1" },
                { "万年雪原", "f9b775" },
                { "树海", "c78db7" },
                { "真理之树", "260df0" },
                { "旅行商队", "1cd93b" },
                { "虚幻的都市", "55b236" },
            },
            {},
            {},
            {},
            {},
            {},
            {},
            {},
            {},
            {},
        }

    },
    darksword = {
        bag_guid = "dc7598",
        guid = {
            { "1", "43421d", "04935c" },
            { "2", "f5c1d7" },
            { "3", "cede03" },
            { "4", "1e1892" },
            { "5", "98e583" },

        },
        mission = {
            bag_guid = "7cbb2f",
            guid = {
                { "跟上脚步", "1a2d30" },
                { "不懂协助", "8c90cc" },
                { "展示给我", "903fcb" },
                { "有能力吗", "12484a" },
                { "守护魔龙", "d9b930" },
                { "挑战魔龙", "60fd3d" },
            },
            dst_pos = {
                { -44.82, 2.1, -6.12 },
                { -48.40, 2.1, -10.97 },
                { -41.26, 2.1, -10.93 },
                { -33.79, 2.1, -11.00 },
                { -33.76, 2.1, -8.21 }
            },
            dst_rot = { 0.00, 180.00, 0.00 },
        },
        table = {
            bag_guid = "ac77d6",
            guid = "501691",
            dst_pos = { -41.48, 1.01, -12.90 },
            dst_rot = { 0.00, 180.00, 0.00 },
        },
    },
    remain = {
        bag_guid = "002bda",
        guid = {
            { "锁住的宝石箱", "68ba69" },
            { "自动防御系统", "81b8f9" },
            { "深不见底的大洞", "fb2e86" },
            { "通向某处的地下通道", "a34e9a" },
            { "密码封锁的门", "7784d7" },
            { "古代魔导要塞", "038624" },
            { "黄金魔像", "cab8ee" },
        },
        relic = {
            bag_guid = "b18a8f",
            guid = {
                { "黄金的母鸡", "7c0bb6" },
                { "仪式魔法：魔兽拘束", "009a29" },
                { "防御护盾发生装置", "bdef6e" },
                { "破碎的沙漏", "7e53c4" },
                { "虹色的魔药", "1faa73" },
            },
            dst_pos = {
                { -21.35, 2.1, -7.21 },
                { -24.92, 2.1, -12.06 },
                { -17.78, 2.1, -12.02 },
                { -10.31, 2.1, -12.10 },
                { -10.28, 2.1, -9.31 }
            },
            dst_rot = { 0.00, 180.00, 0.00 },
        },
    },
    dragon_rage_cnt = { guid = "b31be6" },
    character = {
        bag_guid = "4a7c6b",
        deck_guid = "2ebb1f",
        pbag_guid = "03f784",
        pdeck_guid = "4764a6",
        guid = {
            -- 本体
            { { "角斗士", "bbe811", "3aa484" },
                { "王子", "1fe236", "03d52e" },
                { "忍者", "11af09", "dc1967" },
                { "圣骑士", "77a8a4", "52cb23" },
                { "猎人", "e00b90", "e27dd3" }, },

            --扩展1：秘法
            { { "吟游诗人", "20bf31", "af9fc9" },
                { "魔法师", "bca048", "b4d1c8" }, },

            --扩展2：剑圣
            { { "剑圣", "5947b8", "3babb8" }, },

            --扩展3：修行
            { { "萨满", "17f4a2", "229cce" },
                { "武士", "c26ccc", "807741" }, },

            --扩展4：暗夜
            { { "吸血鬼", "14adce", "c986c9" },
                { "狼人", "dfceae", "cd93f0" }, },
            --扩展5：帝国纪行 无角色
            {},
            --扩展6：帝国之刃
            { { "神射手", "9de41f", "c39e6b" },
                { "主教", "020cf3", "7ca894" },
                { "小丑", "d9abf4", "49c0f6" }, },

            --扩展7：魔龙守护者
            { { "暗黑之剑", "594c97", "2541f9" }, },

            --扩展8：世界树
            { { "机械师", "5e1b5f", "40a511" },
                { "教授", "6d81a7", "50a13d" },
                { "战争机器", "ff207c", "5f87f8" }, },

            --扩展9：天空列岛
            { { "天空行者", "556e43", "999d0a" }, },

            --扩展10：小小大冒险
            { { "驯兽师", "39e563", "efae4b" }, },

            --扩展11：遗迹与古遗产
            { { "遗迹猎人", "245e92", "947934" },
                { "炼金术士", "542746", "bd5b8e" }, },

            -- 扩展1P：死灵军团
            { { "无头骑士", "f563b9", "ead9b9" },
                { "死灵法师", "8764c5", "d43361" },
                { "骸骨刺客", "efb908", "cd73e5" }, },

            -- 扩展2P：梦幻骑士
            { { "十字骑士", "fe5071", "49b2cd" },
                { "翠木骑士", "045c0b", "7b5547" },
                { "黑魔骑士", "aa6ff6", "fecf87" },
                { "星光骑士", "22668c", "fb229e" },
                { "剑刃骑士", "d9cda8", "c11567" }, },
        },
        dst_pos = { -40.00, 0.97, -6.80 },
        dst_rot = { 0.00, 180.00, 0.00 },
        badge_pos = { 66.00, 5.5, 42.00 },
        health_bag_guid = "b0aa70",
        health_guid = "1dd70e",
        exp_bag_guid = "746611",
        exp_guid = "2d0bad",
        res_bag_guid = "68328d",
        res_guid = "7b9afd",
        move_bag_guid = "2c23cf",
        move_guid = "bffd83",
        deter_bag_guid = "4466cb",
        deter_guid = "8fa1be",
        crit_bag_guid = "",
        crit_guid = "8fa1be",
    },
    move_dice = { bag_guid = "2c23cf" },
    deter_dice = { bag_guid = "4466cb" },
    crit_dice = { bag_guid = "", dst_pos = { -40.00, 2, 8.00 } },
    dlc = {
        "本体",
        "扩展1：秘法",
        "扩展2：剑圣",
        "扩展3：修行",
        "扩展4：暗夜",
        "扩展5：帝国纪行",
        "扩展6：帝国之刃",
        "扩展7：魔龙守护者",
        "扩展8：世界树",
        "扩展9：天空列岛",
        "扩展10：小小大冒险",
        "扩展11：遗迹与古遗产",
        "扩展1P：死灵军团", -- 13
        "扩展2P：梦幻骑士",
    },
    map = {
        "地图1",
        "地图2",
        "地图3",
    },
    dlc5_limited = {
        mission_bag_guid = "1ef92c",
        mission_guid = { { "不死者", "3833a4" } },
        decisive_battle_bag_guid = "2e0a4e",
        decisive_battle_guid = {
            { "决战表A", "bdca34" },
            { "决战表B", "896aef" },
            { "决战表C", "7c49c7" },
        },
    }

}
saved_data = {
    map = "map_1",
    selected_dlc = { 1 },
    gameTable_guid = "",
    islayout = false,
    crit_bag_guid = "",
}
players = nil
map = game_data.map_1
selected_dlc = { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14 }
gameTable = {}

function onLoad(saved_state)
    players = Player.getPlayers()
    if saved_state ~= nil and saved_state ~= "" then
        saved_data = JSON.decode(saved_state)
        map = game_data[saved_data.map]
        selected_dlc = saved_data.selected_dlc
        game_data.character.crit_bag_guid = saved_data.crit_bag_guid
        gameTable = getObjectFromGUID(saved_data.gameTable_guid)
        create_menu()

    else
        -- 修改原mod不足
        modify_mod()
        gameTable = spawnObject({ type = "Custom_Board", position = { -46.00, 1.05, 32.00 }, scale = { 0.40, 1.00, 0.40 } })
        gameTable.setCustomObject({ image = "http://cloud-3.steamusercontent.com/ugc/5080654934093444578/5FB4BB16BC0FF73F223FDC28D38C3F25A8B4DE7F/", })
        saved_data.gameTable_guid = gameTable.guid
        create_menu()
        noteCard = spawnObject({ type = "Notecard", position = { -30.05, 1.10, 31.03 }, scale = { 2, 2, 2 } })
        noteCard.setName("脚本说明")
        noteCard.setDescription("1.选择地图和想玩的内容（灰色为选中） \n2.右键空地点击载入 \n3.选择角色卡加入手牌区 \n4.右键空地点击开始。\nP.S.1：如果使用暗黑之剑角色卡的话手动移除魔龙守护者相关道具\nP.S.2：重新开局请重载存档\nP.S.3：如果出现红色错误，请重载存档\nP.S.4：目前不适用强大的龙规则，如要使用请从桌面右上角袋子里手动摆放")
        noteCard.setLock(true)
    end
    if saved_data.islayout then
        addContextMenuItem("开始", startGame, false, true)
    else
        addContextMenuItem("载入", layoutGame, false, true)
    end
end

function onPlayerChangeColor(player_color)
    players = Player.getPlayers()
end

function onSave()
    saved_data.crit_bag_guid = game_data.character.crit_bag_guid
    saved_data.selected_dlc = selected_dlc
    return JSON.encode(saved_data)
end

-- 摆盘
-- TODO 使用getObjects()直接从包中提取物品
function layoutGame()
    Hands.enable = false
    -- 摆放地图
    map_1 = getObjectFromGUID(map.bag_guid).takeObject({ guid = map.guid, position = map.dst_pos, rotation = map.dst_rot,
        smooth = false })
    map_1.setLock(true)

    -- 龙怒指示物
    getObjectFromGUID(game_data.dragon_rage_cnt.guid).setPositionSmooth(map.rage_pos)
    if saved_data.map == "map_2" then
        getObjectFromGUID(game_data.dragon_rage_cnt.guid).clone().setPositionSmooth(map.rage_pos1)
        obstacle_bag1 = getObjectFromGUID(map.limited.obstacle.bag_guid)
        local pos = { -15.00, 2.01, 28.00 }
        for _, guid in ipairs(map.limited.obstacle.guid) do
            obstacle_bag1.takeObject({ guid = guid[2], position = pos })
            pos[2] = pos[2] + 0.1
        end
    end

    -- 拿取烧毁的村庄
    local pos = { 26.00, 2.01, 28.00 }
    bv_bag1 = getObjectFromGUID(map.burned_village.bag_guid)
    for _, guid in ipairs(map.burned_village.guid) do
        bv_bag1.takeObject({ guid = guid[2], position = pos })
        pos[2] = pos[2] + 0.1
    end



    -- 拿取地图3中的天空标记物并摆放航路卡
    if saved_data.map == "map_3" then
        sky_bag1 = getObjectFromGUID(map.limited.sky.bag_guid)
        for _, guid in ipairs(map.limited.sky.guid) do
            sky_bag1.takeObject({ guid = guid[2], position = { 30.00, 2.01, 28.00 } })
        end
        airroute_bag1 = getObjectFromGUID(map.limited.airroute.bag_guid)
        card2deck({ 5.00, 0.97, 28.00 }, airroute_bag1, map.limited.airroute.guid, function(deck)
            deckDeal(deck, map.limited.airroute.dst_pos, function(i, obj)
                obj.setRotation({ 0.00, 210.00, 0.00 })
            end)
        end)
    end
    character_deck = getObjectFromGUID(game_data.character.bag_guid).takeObject({ guid = game_data.character.deck_guid }) --修复20230114更新中角色卡已合堆的bug
    character_pdeck = getObjectFromGUID(game_data.character.pbag_guid).takeObject({ guid = game_data.character.pdeck_guid }) --P扩展角色
    position_base = game_data.character.dst_pos
    position = { table.unpack(position_base) }

    -- 摆放角色卡
    for _, dlc in pairs(selected_dlc) do
        if dlc >= 13 then
            character_bag = character_pdeck
        else
            character_bag = character_deck
        end
        if (game_data.character.guid[dlc] ~= nil) then
            for i = 1, #game_data.character.guid[dlc] do
                if character_bag.getQuantity() == 2 then
                    local last_card_guid = getLastCardGUID(character_bag, game_data.character.guid[dlc][i][2])
                    charachter_card = character_bag.takeObject({ guid = game_data.character.guid[dlc][i][2],
                        position = position, rotation = game_data.character.dst_rot })
                    if dlc >= 13 then
                        character_pdeck = getObjectFromGUID(last_card_guid)
                        character_bag = character_pdeck
                    else
                        character_deck = getObjectFromGUID(last_card_guid)
                        character_bag = character_deck
                    end
                elseif character_bag.getQuantity() == -1 then
                    character_bag.setPositionSmooth(position)
                    character_bag.setRotationSmooth(game_data.character.dst_rot)
                else
                    charachter_card = character_bag.takeObject({ guid = game_data.character.guid[dlc][i][2],
                        position = position, rotation = game_data.character.dst_rot })
                end



                charachter_badge = getObjectFromGUID(game_data.character.guid[dlc][i][3])
                charachter_badge.setPositionSmooth({ position[1] + 2, position[2] + 1, position[3] }, false, false)
                charachter_badge.setRotation(game_data.character.dst_rot)

                position[1] = position[1] + 10
                if (position[1] > (80 + position_base[1])) then
                    position[1] = position_base[1]
                    position[3] = position[3] - 7
                end
            end
        end
    end

    -- 任务卡和奖励卡
    mission_bag1 = getObjectFromGUID(game_data.mission.bag_guid)
    award_bag1 = getObjectFromGUID(map.award.bag_guid)
    wonderworld_bag1 = getObjectFromGUID(game_data.wonderworld.bag_guid)

    mission_guid = {}
    wonderworld_guid = {}
    use_wonderworld = false
    -- 获取dlc中任务、异境数据，并处理dlc中特殊规则
    for k, dlc in pairs(selected_dlc) do
        if (#game_data.mission.guid[dlc] ~= 0) then
            local guid = { table.unpack(game_data.mission.guid[dlc]) }
            for _, id in pairs(guid) do
                table.insert(mission_guid, id)
            end
        end
        if (#game_data.wonderworld.guid[dlc] ~= 0) then
            local guid = { table.unpack(game_data.wonderworld.guid[dlc]) }
            for _, id in pairs(guid) do
                table.insert(wonderworld_guid, id)
            end
        end
        if (dlc == 8) then
            -- 摆放暗黑之剑移动标记
            darksword_bag1 = getObjectFromGUID(game_data.darksword.bag_guid)
            obj2tab({ 0, 0, 0 }, darksword_bag1, game_data.darksword.guid, function(t)
                t = shuffle(t)
                for i = 1, #map.darksword do
                    local obj = t[i].setState(2)
                    obj.setPositionSmooth(map.darksword[i])
                    obj.setRotation({ 0, 0, 0 })
                end
            end)
        end
        if (dlc == 5) then
            use_wonderworld = true
            getObjectFromGUID(game_data.dlc5_limited.mission_bag_guid).takeObject({ guid = game_data.dlc5_limited.mission_guid
                [1][2], position = { -10.00, 0.97, 28.00 } })
            for _, guid in ipairs(game_data.dlc5_limited.decisive_battle_guid
            ) do
                getObjectFromGUID(game_data.dlc5_limited.decisive_battle_bag_guid).takeObject({ guid = guid[2],
                    position = { 38.00, 0.97, 28.00 } })
            end


        end
        if (dlc == 12) then
            -- 摆放遗迹
            remain_bag1 = getObjectFromGUID(game_data.remain.bag_guid)
            card2deck({ 10.00, 0.97, 28.00 }, remain_bag1, game_data.remain.guid, function(deck)
                deck.randomize()
                for i = 1, #game_data.remain.guid do
                    deck.takeObject({ position = map.mountain[i], index = 1, smooth = false })
                end
            end)
            remain_relic_bag1 = getObjectFromGUID(game_data.remain.relic.bag_guid)
            local pos = { 20.00, 3, 28.00 }
            obj2tab(pos, remain_relic_bag1, game_data.remain.relic.guid, function(t)
                t = shuffle(t)
                for i = 1, #map.darksword do
                    local obj = t[i]
                    obj.setPositionSmooth(pos, true, false)
                    obj.setRotation({ 0, 0, 0 })
                    pos[2] = pos[2] + 0.1
                end
            end)
        end
    end
    -- 摆放奖励和任务
    card2deck({ -10.00, 0.97, 28.00 }, award_bag1, map.award.guid, function(deck)
        deck.randomize()
        for i = 1, #map.award.guid do
            deck.takeObject({ position = map.mountain[i], index = 1 })
        end
        Wait.time(function()

            -- 摆放任务卡
            card2deck({ -5.00, 0.97, 28.00 }, mission_bag1, mission_guid, function(deck)
                if map.limited.mission then --存在地图限定任务卡
                    getObjectFromGUID(map.limited.mission.bag_guid).takeObject({ guid = map.limited.mission.guid
                        [1][2],
                        callback_function = function(obj)
                            local deck1 = deck.putObject(obj)
                            deckDeal(deck1, map.mountain, function(i, obj)
                                if i == 5 then
                                    obj.setRotation({ 0.00, 210.00, 0.00 })
                                end
                            end)
                        end })
                else
                    deckDeal(deck, map.mountain, function(i, obj1)
                        if i == 5 then
                            obj1.setRotation({ 0.00, 210.00, 0.00 })
                        end
                    end)
                end
            end)
        end, 0.1)
    end)
    -- 摆放异境卡
    if (#wonderworld_guid ~= 0 and use_wonderworld) then
        card2deck({ 0.00, 0.97, 28.00 }, wonderworld_bag1, wonderworld_guid, function(deck)
            if map.limited.wonderworld then --存在地图限定异境卡
                getObjectFromGUID(map.limited.wonderworld.bag_guid).takeObject({ guid = map.limited.wonderworld.guid
                    [1][2],
                    callback_function = function(obj)
                        deck = deck.putObject(obj)
                        deckDeal(deck, map.wonderworld, function(i, obj)
                            obj.setRotation({ 0.00, 210.00, 0.00 })
                        end)
                    end })
            else
                deckDeal(deck, map.wonderworld, function(i, obj)
                    obj.setRotation({ 0.00, 210.00, 0.00 })
                end)
            end
        end)
    end


    saved_data.islayout = true
    clearContextMenu()
    addContextMenuItem("开始", startGame, false, true)
    Wait.time(function()
        Hands.enable = true
    end, 1)
end

-- 开始游戏
function startGame()
    players_characters = {}
    badge_pos = { table.unpack(game_data.character.badge_pos) }
    if players ~= nil then
        for _, player in ipairs(Player.getPlayers()) do
            if player.seated then
                if player.getHandObjects()[1] == nil then
                    broadcastToAll("请将角色卡拖入手牌后再点击开始", { 1, 0, 0 })
                    return
                else
                    local card_guid = player.getHandObjects()[1].getGUID()
                    getObjectFromGUID(card_guid).highlightOn(player.color)
                    getObjectFromGUID(card_guid).setColorTint(player.color) --由于highlight无法被读取，所以通过color来传递highlight属性
                    -- getObjectFromGUID(card_guid).setPositionSmooth(map.city)
                    table.insert(players_characters, card_guid)
                end

            end
        end
        -- 将其余卡归位
        for k, dlc in ipairs(selected_dlc) do
            for _, character in ipairs(game_data.character.guid[dlc]) do
                if v_include(players_characters, character[2]) then
                    getObjectFromGUID(character[3]).setPositionSmooth(map.city)
                    getObjectFromGUID(character[3]).highlightOn(getObjectFromGUID(character[2]).getColorTint())

                    -- getObjectFromGUID(character[2]).setColorTint({ 0, 0, 0 })
                else -- 没用到的角色卡和徽章归位
                    bag = getObjectFromGUID(game_data.character.bag_guid)
                    bag.putObject(getObjectFromGUID(character[2]))
                    getObjectFromGUID(character[3]).setPositionSmooth(badge_pos)
                    badge_pos[1] = badge_pos[1] + 4
                    if badge_pos[1] > game_data.character.badge_pos[1] + 12 then
                        badge_pos[1] = game_data.character.badge_pos[1]
                        badge_pos[3] = badge_pos[3] - 4
                    end
                end
            end
            if (dlc == 8) then
                -- 摆放暗黑之剑移动标记
                mission_table1 = getObjectFromGUID(game_data.darksword.table.bag_guid).takeObject({ guid = game_data
                    .darksword
                    .table.guid, position = game_data.darksword.table.dst_pos,
                    rotation = game_data.darksword.table.dst_rot })
                mission_table1.setLock(true)

                darksword_bag1 = getObjectFromGUID(game_data.darksword.mission.bag_guid)
                obj2tab({ 8.00, 1.01, 28.00 }, darksword_bag1, game_data.darksword.mission.guid, function(t)
                    t = shuffle(t)
                    for i = 1, #map.darksword do
                        local obj = t[i]
                        obj.setPositionSmooth(game_data.darksword.mission.dst_pos[i])
                        obj.setRotation(game_data.darksword.mission.dst_rot)
                    end
                    local pos = getObjectFromGUID(game_data.darksword.guid[1][3]).getPosition()
                    pos[2] = pos[2] + 0.2
                    pos[3] = pos[3] - 0.9
                    getObjectFromGUID("2541f9").setPositionSmooth(pos)

                end)
            end
        end
        -- 给玩家发放指示物和骰子
        getObjectFromGUID(game_data.character.health_bag_guid).deal(1)
        getObjectFromGUID(game_data.character.exp_bag_guid).deal(1)
        getObjectFromGUID(game_data.character.res_bag_guid).deal(1)
        getObjectFromGUID(game_data.character.move_bag_guid).deal(4)
        getObjectFromGUID(game_data.character.deter_bag_guid).deal(4)
        getObjectFromGUID(game_data.character.crit_bag_guid).deal(4)
    else
        broadcastToAll("请将角色卡拖入手牌后再点击开始", { 1, 0, 0 })
    end

end

function onObjectLeaveContainer(container, object)
    -- 追加移动骰的脚本
    -- if (container.guid == game_data.move_dice.bag_guid)
    -- then
    --     object.setLuaScript("rolling = false\r\nfunction onUpdate()\r\nif rolling and self.resting then\r\nrolling = false\r\nvalue = self.getValue()\r\nif value == 1 then\r\nself.highlightOn({ 0, 0, 0 })\r\nend\r\nif value == 2 then\r\nself.highlightOn({ 1, 1, 1 })\r\nend\r\nif value == 3 or value == 4 then\r\nself.highlightOn({ 1, 1, 0 })\r\nend\r\nif value == 5 or value == 6 then\r\nself.highlightOn({ 0, 1, 0 })\r\nend\r\nend\r\nend\r\n\r\nfunction onCollisionEnter(info)\r\nend\r\n\r\nfunction onPlayerAction(player, action, targets)\r\nif action == 8 or action==9 then\r\nrolling = true\r\nself.setColorTint({ 1, 1, 1 })\r\nend\r\nend\r\n")
    -- elseif (container.guid == game_data.deter_dice.bag_guid) then
    --     object.setRotationValues({
    --         { value = "-1", rotation = { -90.0, 0.0, 0.0 } },
    --         { value = "0", rotation = { 0.0, 0.0, 0.0 } },
    --         { value = "0", rotation = { 0.0, 0.0, -90.0 } },
    --         { value = "1", rotation = { 0.0, 0.0, 90.0 } },
    --         { value = "1", rotation = { 0.0, 0.0, -180.0 } },
    --         { value = "1", rotation = { 90.0, 0.0, 0.0 } }
    --     })
    --     object.setLuaScript("rolling = false\r\nfunction onUpdate()\r\nif rolling and self.resting then\r\nrolling = false\r\nif self.getValue() == 6 then\r\nself.highlightOn({ 0, 1, 0 })\r\nself.setColorTint({ 0, 1, 0 })\r\nend\r\nend\r\nend\r\n\r\nfunction onCollisionEnter(info)\r\nrolling = true\r\nself.highlightOff()\r\nself.setColorTint({ 1, 1, 1 })\r\n\r\nend")

    -- elseif (container.guid == game_data.crit_dice.bag_guid) then
    --     object.setRotationValues({
    --         { value = "-1", rotation = { -90.0, 0.0, 0.0 } },
    --         { value = "1", rotation = { 0.0, 0.0, 0.0 } },
    --         { value = "1", rotation = { 0.0, 0.0, -90.0 } },
    --         { value = "1", rotation = { 0.0, 0.0, 90.0 } },
    --         { value = "1", rotation = { 0.0, 0.0, -180.0 } },
    --         { value = "1", rotation = { 90.0, 0.0, 0.0 } }
    --     })
    --     object.setColorTint({ 1, 1, 0 })
    -- end
end

---------------对原MOD改动函数-------------------
function modify_mod()
    modify_move_dice()
    modify_deter_dice()

end

-- 增加暴击骰
function add_crit_dice()
    obj = getObjectFromGUID(game_data.deter_dice.bag_guid).getData()
    obj.Nickname = "暴击骰"
    obj.ContainedObjects[1].Nickname = "暴击骰"
    obj.ContainedObjects[1].ColorDiffuse = { 1, 1, 0 }
    obj.ContainedObjects[1].RotationValues[2].Value = "1"
    obj.ContainedObjects[1].RotationValues[3].Value = "1"
    obj.ContainedObjects[1].LuaScript = "rolling = false\r\nfunction onUpdate()\r\nif rolling and self.resting then\r\nrolling = false\r\nif self.getValue() == 6 then\r\nself.highlightOn({ 0, 1, 0 })\r\nend\r\nend\r\nend\r\n\r\nfunction onCollisionEnter(info)\r\nrolling = true\r\nself.highlightOff()\r\n\r\nend"

    game_data.character.crit_bag_guid = spawnObjectData({ data = obj, position = game_data.crit_dice.dst_pos,
        callback_function = function(spawned_object)
            game_data.crit_dice.bag_guid = spawned_object.guid
        end }).guid
end

-- 追加判定骰脚本
function modify_deter_dice()
    obj = getObjectFromGUID(game_data.deter_dice.bag_guid).getData()
    obj.ContainedObjects[1].RotationValues[1].Value = "-1"
    obj.ContainedObjects[1].RotationValues[2].Value = "0"
    obj.ContainedObjects[1].RotationValues[3].Value = "0"
    obj.ContainedObjects[1].RotationValues[4].Value = "1"
    obj.ContainedObjects[1].RotationValues[5].Value = "1"
    obj.ContainedObjects[1].RotationValues[6].Value = "1"
    obj.ContainedObjects[1].LuaScript = "rolling = false\r\nfunction onUpdate()\r\nif rolling and self.resting then\r\nrolling = false\r\nif self.getValue() == 6 then\r\nself.highlightOn({ 0, 1, 0 })\r\nend\r\nend\r\nend\r\n\r\nfunction onCollisionEnter(info)\r\nrolling = true\r\nself.highlightOff()\r\n\r\nend"

    getObjectFromGUID(game_data.deter_dice.bag_guid).destroyObject()
    spawnObjectData({ data = obj, callback_function = function(spawned_object)
        game_data.deter_dice.bag_guid = spawned_object.guid
        add_crit_dice()
    end })
end

-- 追加移动骰脚本
function modify_move_dice()
    obj = getObjectFromGUID(game_data.move_dice.bag_guid).getData()
    obj.ContainedObjects[1].LuaScript = "rolling = false\r\nfunction onUpdate()\r\nif rolling and self.resting then\r\nrolling = false\r\nvalue = self.getValue()\r\nif value == 1 then\r\nself.highlightOn({ 1, 0, 1 })\r\nend\r\nif value == 2 then\r\nself.highlightOn({ 1, 1, 1 })\r\nend\r\nif value == 3 or value == 4 then\r\nself.highlightOn({ 1, 1, 0 })\r\nend\r\nif value == 5 then\r\nself.highlightOn({ 0, 1, 0 })\r\nend\r\nif value == 6 then\r\nself.highlightOn({ 1, 0, 0 })\r\nend\r\n\r\nend\r\nend\r\n\r\nfunction onCollisionEnter(info)\r\nend\r\n\r\nfunction onPlayerAction(player, action, targets)\r\nif action == 8 or action==9 then\r\nrolling = true\r\nself.setColorTint({ 1, 1, 1 })\r\nend\r\nend\r\n"

    getObjectFromGUID(game_data.move_dice.bag_guid).destroyObject()
    spawnObjectData({ data = obj, callback_function = function(spawned_object)
        game_data.move_dice.bag_guid = spawned_object.guid
    end })
end

---------------UI函数-------------------
function create_menu()
    local allUI = {}
    x = -300
    for i = 1, 14 do
        table.insert(allUI, { tag = 'ToggleButton',
            attributes = {
                onValueChanged = 'Global/selectDlc',
                id = "dlc " .. i,
                width = 400,
                height = 200,
                position = x - 300 .. " " .. -(math.ceil(i / 2) * 220 - 900) .. ' -80',
                text = game_data.dlc[i],
                fontSize = 70,
                isOn = (function()
                    if v_include(selected_dlc, i) then
                        return true
                    else
                        return false
                    end
                end)()
            } })
        x = -x
    end
    for i = 1, 3 do
        table.insert(allUI, { tag = 'ToggleButton',
            attributes = {
                onValueChanged = 'Global/selectMap',
                id = "map_" .. i,
                width = 400,
                height = 200,
                position = 600 .. " " .. -(i * 350 - 700) .. ' -80',
                text = game_data.map[i],
                fontSize = 70,
                isOn = (function()
                    if saved_data.map == "map_" .. i then
                        return true
                    else
                        return false
                    end
                end)()

            } })
    end
    gameTable.UI.setXmlTable(allUI)
end

function selectDlc(player, value, id)
    s = split(id, " ")
    if (value == "True")
    then
        table.insert(selected_dlc, tonumber(s[2]))
        gameTable.UI.setAttribute(id, "isOn", true)
    else
        if s[2] == "1" then
            gameTable.UI.setAttribute(id, "isOn", true)
        else
            removeTableData(selected_dlc, tonumber(s[2]))
            gameTable.UI.setAttribute(id, "isOn", false)
        end
    end
end

function selectMap(player, value, id)
    if (value == "True")
    then
        for i = 1, 3 do
            gameTable.UI.setAttribute("map_" .. i, "isOn", false)
        end
        map = game_data[id]
        saved_data.map = id
        gameTable.UI.setAttribute(id, "isOn", true)
    else
        gameTable.UI.setAttribute(id, "isOn", true)
    end
end

---------------工具函数-------------------

-- 把卡片从袋子里取出来并且组成卡堆执行函数
function card2deck(pos, bag, card_guid, cb)
    bag.takeObject({ position = pos,
        rotation = { 0.00, 210.00, 180.00 }, guid = card_guid[1][2],
        callback_function = function(obj)
            local deck = obj
            bag.takeObject({
                rotation = { 0.00, 210.00, 180.00 }, guid = card_guid[2][2],
                callback_function = function(obj)
                    deck = deck.putObject(obj)
                    award = {}
                    for i = 3, #card_guid do
                        bag.takeObject({
                            rotation = { 0.00, 210.00, 180.00 }, guid = card_guid[i][2],
                            callback_function = function(obj)

                                deck = deck.putObject(obj)
                                if deck.getQuantity() == #card_guid then
                                    cb(deck)
                                end
                            end,
                            smooth = false
                        })
                    end
                end,
                smooth = false
            })
        end,
        smooth = false })
end

-- 把无法堆叠的物品洗乱并放到pos指定位置
function obj2tab(pos, bag, guid, cb)
    t = {}
    for i = 1, #guid do
        bag.takeObject({ position = pos,
            rotation = { 0.00, 210.00, 180.00 }, guid = guid[i][2],
            callback_function = function(obj1)
                table.insert(t, obj1)
                if #t == #guid then
                    cb(t)
                end
            end,
            smooth = false
        })
    end
end

-- 把牌堆洗乱并且发到对应位置
function deckDeal(deck, pos, fun)
    deck.randomize()
    for i = 1, #pos do
        obj = deck.takeObject({ position = pos[i], index = 1 })
        fun(i, obj)
    end
end

function v_include(tab, value)
    for k, v in pairs(tab) do
        if v == value then
            return true
        end
    end
    return false
end

function split(str, delimiter)
    local dLen = string.len(delimiter)
    local newDeli = ''
    for i = 1, dLen, 1 do
        newDeli = newDeli .. "[" .. string.sub(delimiter, i, i) .. "]"
    end

    local locaStart, locaEnd = string.find(str, newDeli)
    local arr = {}
    local n = 1
    while locaStart ~= nil do
        if locaStart > 0 then
            arr[n] = string.sub(str, 1, locaStart - 1)
            n = n + 1
        end

        str = string.sub(str, locaEnd + 1, string.len(str))
        locaStart, locaEnd = string.find(str, newDeli)
    end
    if str ~= nil then
        arr[n] = str
    end
    return arr
end

function removeTableData(tb, val)
    for i = #tb, 1, -1 do
        if tb[i] == val then
            table.remove(tb, i)
            return
        end
    end
end

function shuffle(t)
    if type(t) ~= "table" then
        return
    end
    local tab = {}
    local index = 1
    while #t ~= 0 do
        local n = math.random(0, #t)
        if t[n] ~= nil then
            tab[index] = t[n]
            table.remove(t, n)
            index = index + 1
        end
    end
    return tab
end

function getLastCardGUID(deck, guid)
    local deck_contents = deck.getObjects()
    for index, value in ipairs(deck_contents) do
        if value.guid ~= guid then
            return value.guid
        end
    end
end
